<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lição — EnglishPlay</title>

    <link rel="stylesheet" href="estilo.css">

    <style>
        .lesson-container {
            width: 650px;
            background: #111;
            padding: 25px;
            border-radius: 20px;
            border: 3px solid #ffcc00;
            margin: 130px auto;
        }

        .question {
            font-size: 22px;
            margin-bottom: 25px;
            color: #ffcc00;
            font-weight: 600;
        }

        .choice {
            width: 100%;
            padding: 14px;
            background: #1a1a1a;
            border-radius: 12px;
            border: 2px solid #333;
            margin-bottom: 12px;
            cursor: pointer;
            transition: .2s;
        }

        .choice:hover {
            border-color: #ffcc00;
            transform: scale(1.03);
        }

        .write-box {
            width: 100%;
            padding: 14px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 16px;
        }

        .drag-area {
            margin-top: 18px;
            padding: 12px;
            background: #0b0b0b;
            border: 2px dashed #444;
            border-radius: 15px;
            min-height: 70px;
        }

        .word {
            display: inline-block;
            background: #ffcc00;
            color: black;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 18px;
            cursor: grab;
            margin: 6px;
        }

        .next-btn {
            width: 100%;
            margin-top: 18px;
            padding: 13px;
            background: #ffcc00;
            border-radius: 15px;
            font-weight: 700;
            color: black;
            cursor: pointer;
        }

        .progress {
            margin-bottom: 12px;
            color: #ffcc00;
        }

        #feedback {
            margin-top: 15px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
    <div class="nav-left" onclick="location.href='index.html'">
        <img src="logo.png">
        <div class="nav-title">EnglishPlay</div>
    </div>

    <input type="text" disabled class="search-box" placeholder="Lição atual">

    <button class="btn-yellow" onclick="sair()">Sair</button>
</div>

<div class="lesson-container">
    <div class="progress" id="progressText">Carregando...</div>
    <div class="question" id="questionText">...</div>

    <!-- Múltipla escolha -->
    <div id="choicesBox"></div>

    <!-- Escrita -->
    <input id="writeInput" class="write-box" style="display:none" placeholder="Digite aqui...">

    <!-- Montar frase -->
    <div id="dragWords"></div>
    <div id="dragArea" class="drag-area"></div>

    <div id="feedback"></div>

    <button class="next-btn" onclick="nextQuestion()">Continuar</button>
</div>

<script src="storage.js"></script>
<script src="lições.js"></script>
<script src="mascotes.js"></script>

<script>
/* =====================================================
    CARREGAR LIÇÃO
===================================================== */

let lessonId = localStorage.getItem("lessonOpen");
if (!lessonId) {
    alert("Erro: nenhuma lição selecionada.");
    location.href = "index.html";
}

let exercicios = getLesson(lessonId); 
let indexEx = 0;
let total = exercicios.length;

let answerLocked = false;

const qText = document.getElementById("questionText");
const cBox = document.getElementById("choicesBox");
const wInput = document.getElementById("writeInput");
const dragWords = document.getElementById("dragWords");
const dragArea = document.getElementById("dragArea");
const feedback = document.getElementById("feedback");
const progressText = document.getElementById("progressText");

/* =====================================================
    MOSTRAR EXERCÍCIO
===================================================== */

function showExercise() {
    answerLocked = false;
    feedback.textContent = "";
    dragArea.innerHTML = "";
    dragWords.innerHTML = "";
    wInput.value = "";

    let ex = exercicios[indexEx];

    progressText.textContent = `Exercício ${indexEx + 1} de ${total}`;
    qText.textContent = ex.question;

    cBox.innerHTML = "";
    wInput.style.display = "none";
    dragArea.style.display = "none";
    dragWords.style.display = "none";

    if (ex.type === "choice") {
        ex.options.forEach(opt => {
            let btn = document.createElement("div");
            btn.className = "choice";
            btn.textContent = opt;

            btn.onclick = () => checkAnswer(opt);
            cBox.appendChild(btn);
        });
    }

    if (ex.type === "write") {
        wInput.style.display = "block";
        wInput.oninput = () => checkWrite();
    }

    if (ex.type === "drag") {
        dragArea.style.display = "block";
        dragWords.style.display = "block";

        ex.words.sort(() => Math.random() - 0.5);

        ex.words.forEach(w => {
            let el = document.createElement("span");
            el.className = "word";
            el.textContent = w;

            el.onclick = () => {
                dragArea.textContent += w + " ";
            };

            dragWords.appendChild(el);
        });
    }
}

/* =====================================================
    CHECAR RESPOSTA
===================================================== */

function checkAnswer(userAnswer) {
    if (answerLocked) return;
    answerLocked = true;

    let correct = exercicios[indexEx].answer;

    if (userAnswer === correct) {
        feedback.style.color = "#3cb043";
        feedback.textContent = "✔ Correto!";
        mascoteAcerto();
    } else {
        feedback.style.color = "#ff5050";
        feedback.textContent = "✖ Errado — " + correct;
        mascoteErro();
    }
}

function checkWrite() {
    let user = wInput.value.trim().toLowerCase();
    let correct = exercicios[indexEx].answer.toLowerCase();

    if (user === correct) {
        feedback.style.color = "#3cb043";
        feedback.textContent = "✔ Correto!";
        mascoteAcerto();
        answerLocked = true;
    }
}

function nextQuestion() {
    if (!answerLocked && exercicios[indexEx].type !== "write") {
        alert("Responda antes de continuar!");
        return;
    }

    indexEx++;

    if (indexEx >= total) {
        finishLesson();
        return;
    }

    showExercise();
}

/* =====================================================
    FINALIZAR LIÇÃO
===================================================== */

function finishLesson() {
    completeLesson(lessonId, 20); // dá 20 XP
    mascoteFala("Parabéns! Lição concluída!");
    alert("Lição concluída!");
    location.href = "index.html";
}

function sair() {
    logout();
}

showExercise();
</script>

</body>
</html>
