<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula â€” EnglishPlay</title>

    <link rel="stylesheet" href="style.css">
    <script src="lessons.js" defer></script>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
    <div class="nav-logo" onclick="location.href='index.html'">
        <img src="logo.png">
        <span class="nav-title">EnglishPlay</span>
    </div>

    <input type="text" class="search-box" placeholder="Pesquisar..." disabled>

    <div class="nav-user" onclick="logout()">Sair</div>
</header>

<!-- CONTEÃšDO DA AULA -->
<div class="main" style="justify-content:center; margin-top:130px;">
    <div class="section-box" style="width:700px;">

        <h2 id="lessonTitle" class="section-title">Carregando...</h2>

        <!-- Barra de progresso -->
        <div class="progress-bar" style="
            width:100%; 
            background:#222; 
            height:12px; 
            border-radius:10px; 
            margin:20px 0;
        ">
            <div id="progressFill" style="
                width:0%; 
                height:100%; 
                border-radius:10px; 
                background:linear-gradient(to right, #ffcc00, #ffee88);
                transition:0.4s ease;
            "></div>
        </div>

        <!-- CAIXA DA AULA -->
        <div id="lessonBlock" class="lesson-block">
            Carregando exercÃ­cios...
        </div>

    </div>
</div>


<script>
/* ============================================================
   CARREGAR SESSÃƒO E USUÃRIO
============================================================ */

let SESSION = JSON.parse(localStorage.getItem("session"));
let USERS = JSON.parse(localStorage.getItem("users")) || {};

if (!SESSION) {
    alert("VocÃª precisa estar logado!");
    window.location.href = "auth.html";
}

const params = new URLSearchParams(window.location.search);
const lessonId = Number(params.get("id"));

if (!lessonId) {
    alert("Aula invÃ¡lida.");
    window.location.href = "index.html";
}

document.getElementById("lessonTitle").innerText = "LiÃ§Ã£o " + lessonId;


/* ============================================================
   SISTEMA DE AULA (5 exercÃ­cios)
============================================================ */

let index = 0;
const total = 5;

/* Atualizar barra de progresso */
function updateProgress() {
    document.getElementById("progressFill").style.width = (index / total * 100) + "%";
}

/* Carregar prÃ³ximo exercÃ­cio */
function renderExercise() {
    updateProgress();

    if (index >= total) {
        finishLesson();
        return;
    }

    const exercise = LESSONS[index];
    const block = document.getElementById("lessonBlock");

    if (exercise.type === "choice") {
        block.innerHTML = `
            <h3>${exercise.question}</h3>
            ${exercise.options.map(op => `
                <button class="btn-main" onclick="checkChoice('${op}', '${exercise.answer}')">
                    ${op}
                </button>
            `).join("")}
        `;
    }

    if (exercise.type === "write") {
        block.innerHTML = `
            <h3>${exercise.question}</h3>
            <input id="writeInput" class="input-write" placeholder="Digite aqui...">
            <button class="btn-main" onclick="checkWrite('${exercise.answer}')">Verificar</button>
        `;
    }

    if (exercise.type === "drag") {
        block.innerHTML = `
            <h3>${exercise.question}</h3>
            <div id="dragArea"></div>
            <div id="dropZone" style="
                min-height:70px; 
                border:2px dashed #555; 
                padding:10px; 
                border-radius:12px; 
                margin-top:12px;">
            </div>
            <button class="btn-main" onclick="checkDrag('${exercise.answer}')">Verificar</button>
        `;

        exercise.words.forEach(w => {
            let bubble = document.createElement("span");
            bubble.className = "word-bubble";
            bubble.innerText = w;
            bubble.draggable = true;

            bubble.ondragstart = e => {
                e.dataTransfer.setData("text", w);
            };

            document.getElementById("dragArea").appendChild(bubble);
        });

        document.getElementById("dropZone").ondragover = e => e.preventDefault();
        document.getElementById("dropZone").ondrop = e => {
            e.preventDefault();
            let w = e.dataTransfer.getData("text");
            document.getElementById("dropZone").innerHTML += `<span class="word-bubble">${w}</span>`;
        };
    }
}

renderExercise();


/* ============================================================
   VERIFICAÃ‡ÃƒO DAS RESPOSTAS
============================================================ */

function checkChoice(selected, correct) {
    feedback(selected === correct, correct);
}

function checkWrite(correct) {
    let val = document.getElementById("writeInput").value.trim().toLowerCase();
    feedback(val === correct.toLowerCase(), correct);
}

function checkDrag(correct) {
    let dropped = [...document.querySelectorAll("#dropZone .word-bubble")]
        .map(e => e.innerText)
        .join(" ");

    feedback(dropped === correct, correct);
}


/* ============================================================
   FEEDBACK E XP
============================================================ */

function feedback(ok, correctAnswer) {
    let block = document.getElementById("lessonBlock");

    if (ok) {
        block.classList.add("correct-flash");

        SESSION.xp += 10;
        USERS[SESSION.name] = SESSION;
        localStorage.setItem("users", JSON.stringify(USERS));
        localStorage.setItem("session", JSON.stringify(SESSION));

        setTimeout(() => {
            block.classList.remove("correct-flash");
            index++;
            renderExercise();
        }, 600);

    } else {
        block.classList.add("error-flash");

        block.innerHTML += `
            <p style="color:#ff6666; margin-top:10px;">
                Correto: <b>${correctAnswer}</b>
            </p>
        `;

        setTimeout(() => {
            block.classList.remove("error-flash");
        }, 600);
    }
}


/* ============================================================
   FINAL DA AULA
============================================================ */

function finishLesson() {
    let block = document.getElementById("lessonBlock");

    block.innerHTML = `
        <h2>ðŸŽ‰ ParabÃ©ns!</h2>
        <p>VocÃª completou a liÃ§Ã£o!</p>
        <p>+10 XP ganhos</p>
        <button class="btn-main" onclick="location.href='index.html'">
            Voltar ao InÃ­cio
        </button>
    `;

    SESSION.lessonsUnlocked = Math.max(SESSION.lessonsUnlocked, lessonId + 1);
    USERS[SESSION.name] = SESSION;

    localStorage.setItem("users", JSON.stringify(USERS));
    localStorage.setItem("session", JSON.stringify(SESSION));
}
</script>

</body>
</html>
