// app.js core for index - handles auth flow, lessons list, notifications and payment modal
var PIX_QR = "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=00020126580014BR.GOV.BCB.PIX0136d9b1e552-e431-4d8b-b28e-eca5cddf654252040000530398654040.995802BR5922Edmilson%20dos%20Reis%20Lima6009SAO%20PAULO621405102mUMXXZDnB63047198";
function getUsers(){try{return JSON.parse(localStorage.getItem('ep_users')||'[]')}catch(e){return[]}}function setUsers(u){localStorage.setItem('ep_users',JSON.stringify(u))}function getCurrent(){return localStorage.getItem('ep_current')}
document.addEventListener('DOMContentLoaded', function(){ if(window.location.pathname.endsWith('index.html')|| window.location.pathname.endsWith('/')){ var cur = getCurrent(); if(!cur){ window.location.href='login.html'; return;} var users = getUsers(); var me = users.find(function(x){return x.email===cur}); var params = new URLSearchParams(window.location.search); var isNew = params.get('new'); if(isNew==='1'){ document.getElementById('questionario').style.display='block'; document.getElementById('q-email').value = me.email; document.getElementById('q-name').value = me.name; document.getElementById('mainMenu').style.display='none'; } else { document.getElementById('questionario').style.display='none'; document.getElementById('mainMenu').style.display='block'; document.getElementById('userName').textContent = me.name; document.getElementById('dailyTarget').textContent = (me.target||7)+' dias'; } // questionnaire submit var form = document.getElementById('quizForm'); if(form){ form.addEventListener('submit', function(e){ e.preventDefault(); var age=document.getElementById('q-age').value; var target=document.getElementById('q-target').value; me.age=age; me.target=Number(target)||7; setUsers(users); document.getElementById('questionario').style.display='none'; document.getElementById('mainMenu').style.display='block'; }) } // populate lessons var grid = document.getElementById('lessonsGrid'); grid.innerHTML=''; for(var i=1;i<=6;i++){ (function(i){ var card=document.createElement('div'); card.className='lesson-card'; var title=document.createElement('h3'); title.textContent='Aula '+i; var p=document.createElement('p'); p.className='small'; p.textContent = (i<=2)?'Grátis':'Pago'; var btn=document.createElement('a'); btn.className='btn'; var completed = me.completed || []; if(completed.includes(i)){ btn.textContent='Revisar '+i; btn.href = 'lesson'+(i<=2?i:'1')+'.html'; } else { if(i<=2){ btn.textContent='Abrir Aula '+i; btn.href='lesson'+i+'.html'; } else { btn.textContent='Desbloquear'; btn.href='#'; btn.addEventListener('click', function(ev){ ev.preventDefault(); openPayModal(i); }); } } card.appendChild(title); card.appendChild(p); card.appendChild(btn); grid.appendChild(card); })(i); } // notifications var notifBtn = document.getElementById('notifBtn'); var notifCount = document.getElementById('notifCount'); var ncount = (me.notifications || []).length; if(ncount>0){ notifCount.style.display='inline-block'; notifCount.textContent = ncount; } else notifCount.style.display='none'; notifBtn.addEventListener('click', function(){ var list = me.notifications || []; if(list.length===0){ alert('Sem notificações'); return;} var txt = list.map(function(n){return n.from+' — '+n.type}).join('\n'); if(confirm('Notificações:\n'+txt+'\n\nDeseja aceitar o primeiro pedido de amizade?')){ var req = list.find(function(x){return x.type==='friend_request'}); if(req){ var other = users.find(function(x){return x.email===req.email}); if(other){ me.friends = me.friends||[]; other.friends = other.friends||[]; if(!me.friends.includes(other.email)) me.friends.push(other.email); if(!other.friends.includes(me.email)) other.friends.push(me.email); me.notifications = me.notifications.filter(function(x){return x!==req}); setUsers(users); alert('Amizade aceita!'); window.location.reload(); } } } }); document.getElementById('threeDots').addEventListener('click', function(){ var m = document.getElementById('menuDots'); m.style.display = (m.style.display==='block')? 'none':'block'; }); document.getElementById('logoutBtn').addEventListener('click', function(){ localStorage.removeItem('ep_current'); window.location.href='login.html'; }); }});
function openPayModal(lesson){ var modal = document.createElement('div'); modal.style.position='fixed'; modal.style.left=0; modal.style.top=0; modal.style.right=0; modal.style.bottom=0; modal.style.background='rgba(2,6,23,0.6)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex=9999; modal.innerHTML = '<div style="background:#071827;padding:18px;border-radius:10px;max-width:560px;color:#e6f4ff"><h3>Desbloquear Aula '+lesson+'</h3><p>Pagamento via PIX (chave EMV) ou cartão (simulado).</p><div style="display:flex;gap:12px;align-items:center"><img src="'+PIX_QR+'" width="160"><div><button class="btn" id="copyPix">Copiar código PIX</button></div></div><hr><div><h4>Pagamento com cartão (simulado)</h4><input class="input" placeholder="Número do cartão"><input class="input" placeholder="MM/AA"><input class="input" placeholder="CVV"><div style="text-align:right;margin-top:8px"><button class="btn" id="payCard">Pagar (simulado)</button></div></div><div style="text-align:right;margin-top:8px"><button id="closeModal" class="btn">Fechar</button></div></div>'; document.body.appendChild(modal); document.getElementById('closeModal').addEventListener('click', function(){ modal.remove(); }); document.getElementById('copyPix').addEventListener('click', function(){ navigator.clipboard.writeText("00020126580014BR.GOV.BCB.PIX0136d9b1e552-e431-4d8b-b28e-eca5cddf654252040000530398654040.995802BR5922Edmilson dos Reis Lima6009SAO PAULO621405102mUMXXZDnB63047198"); alert('Código PIX copiado'); }); document.getElementById('payCard').addEventListener('click', function(){ alert('Pagamento simulado — obrigado'); var cur = getCurrent(); var users = getUsers(); var me = users.find(function(x){return x.email===cur}); if(me){ me.completed = me.completed || []; if(!me.completed.includes(3)) me.completed.push(3); setUsers(users); } modal.remove(); window.location.reload(); });}