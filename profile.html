<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil ‚Äî EnglishPlay</title>

    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
    <div class="nav-logo" onclick="location.href='index.html'">
        <img src="logo.png">
        <span class="nav-title">EnglishPlay</span>
    </div>

    <input type="text" class="search-box" placeholder="Pesquisar..." disabled>

    <div class="nav-user" onclick="logout()">Sair</div>
</header>


<div class="main" style="justify-content:center; margin-top:130px;">
    <div class="section-box" style="width:600px;">

        <h2 class="section-title">üë§ Meu Perfil</h2>

        <div style="text-align:center; margin-bottom:20px;">

            <!-- FOTO -->
            <img id="profileImg" src="logo.png" 
                style="width:160px; height:160px; border-radius:50%; cursor:pointer;"
                onclick="document.getElementById('imgInput').click()">

            <input id="imgInput" type="file" accept="image/*" style="display:none;" onchange="changeAvatar()">

            <h2 id="pName" style="margin-top:12px;"></h2>

            <!-- Alterar nome -->
            <input id="newNameInput" placeholder="Novo nome..." 
                   style="padding:12px; width:75%; border-radius:12px; margin-top:12px; background:#1a1a1a; color:white; border:2px solid #333;">
            <button class="btn-main" onclick="updateName()" style="margin-top:10px;">Alterar Nome</button>

        </div>

        <hr style="border-color:#444; margin:20px 0;">

        <!-- INFORMACOES -->
        <h3>‚≠ê XP Total:</h3>
        <p id="pXP"></p>

        <h3 style="margin-top:12px;">üî• Dias consecutivos:</h3>
        <p id="pStreak"></p>

        <hr style="border-color:#444; margin:20px 0;">

        <!-- AMIGOS -->
        <h2 class="section-title">ü§ù Amigos</h2>

        <div id="friendsList" style="margin-bottom:25px;">
            Carregando amigos...
        </div>

        <!-- PEDIDOS DE AMIZADE -->
        <h2 class="section-title">üì® Pedidos de amizade</h2>

        <div id="requestsList">
            Carregando pedidos...
        </div>

        <hr style="border-color:#444; margin:25px 0;">

        <button class="btn-main" onclick="deleteAccount()" style="background:red; color:white;">
            Excluir Conta
        </button>

    </div>
</div>


<script>
/* =======================================================
   VERIFICA√á√ÉO DE LOGIN
======================================================= */

let SESSION = JSON.parse(localStorage.getItem("session"));
let USERS = JSON.parse(localStorage.getItem("users"));

if (!SESSION) {
    window.location.href = "auth.html";
}


/* =======================================================
   CARREGAR DADOS DO PERFIL
======================================================= */

function loadProfile() {
    document.getElementById("profileImg").src = SESSION.avatar || "logo.png";
    document.getElementById("pName").innerText = SESSION.name;
    document.getElementById("pXP").innerText = SESSION.xp + " XP";
    document.getElementById("pStreak").innerText = SESSION.streak + " dias";

    loadFriends();
    loadRequests();
}

document.addEventListener("DOMContentLoaded", loadProfile);


/* =======================================================
   ALTERAR AVATAR
======================================================= */

function changeAvatar() {
    let input = document.getElementById("imgInput").files[0];
    if (!input) return;

    let reader = new FileReader();
    reader.onload = () => {
        SESSION.avatar = reader.result;
        USERS[SESSION.name].avatar = reader.result;

        localStorage.setItem("users", JSON.stringify(USERS));
        localStorage.setItem("session", JSON.stringify(SESSION));

        loadProfile();
    };

    reader.readAsDataURL(input);
}


/* =======================================================
   ALTERAR NOME (m√°x. 3x)
======================================================= */

SESSION.nameChanges = SESSION.nameChanges || 0;

function updateName() {
    let newName = document.getElementById("newNameInput").value.trim();

    if (newName.length < 3) {
        alert("Nome muito curto!");
        return;
    }

    if (USERS[newName]) {
        alert("Nome j√° existe!");
        return;
    }

    if (SESSION.nameChanges >= 3) {
        alert("Voc√™ j√° atingiu o limite de mudan√ßas.");
        return;
    }

    let oldName = SESSION.name;

    USERS[newName] = USERS[oldName];
    delete USERS[oldName];

    SESSION.name = newName;
    SESSION.nameChanges++;

    localStorage.setItem("users", JSON.stringify(USERS));
    localStorage.setItem("session", JSON.stringify(SESSION));

    loadProfile();
    alert("Nome alterado com sucesso!");
}


/* =======================================================
   LISTA DE AMIGOS
======================================================= */

function loadFriends() {
    let list = document.getElementById("friendsList");
    let friends = SESSION.friends || [];

    if (friends.length === 0) {
        list.innerHTML = "<p>Nenhum amigo ainda.</p>";
        return;
    }

    list.innerHTML = friends
        .map(f => `<p>‚Ä¢ ${f}</p>`)
        .join("");
}


/* =======================================================
   PEDIDOS DE AMIZADE
======================================================= */

function loadRequests() {
    let list = document.getElementById("requestsList");
    let reqs = SESSION.requests || [];

    if (reqs.length === 0) {
        list.innerHTML = "<p>Nenhum pedido pendente.</p>";
        return;
    }

    list.innerHTML = reqs
        .map(r => `
            <p>${r} 
                <button class="btn-main" style="padding:6px 12px;"
                        onclick="acceptRequest('${r}')">Aceitar</button>
            </p>
        `)
        .join("");
}

function acceptRequest(user) {
    SESSION.friends.push(user);
    SESSION.requests = SESSION.requests.filter(r => r !== user);

    USERS[SESSION.name] = SESSION;
    USERS[user].friends.push(SESSION.name);

    localStorage.setItem("users", JSON.stringify(USERS));
    localStorage.setItem("session", JSON.stringify(SESSION));

    loadRequests();
    loadFriends();
}


/* =======================================================
   EXCLUIR CONTA
======================================================= */

function deleteAccount() {
    if (!confirm("Tem certeza que deseja excluir sua conta?")) return;

    delete USERS[SESSION.name];
    localStorage.setItem("users", JSON.stringify(USERS));

    localStorage.removeItem("session");
    window.location.href = "auth.html";
}
</script>

</body>
</html>
